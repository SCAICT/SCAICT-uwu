<!-- @format -->

<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ä¸­é›»å•†åº—</title>
        <meta name="description" content="ä½¿ç”¨ä½ çš„é›»é›»é»ä¾†å…Œæ›çå“å§!" />
        <meta name="author" content="ä¸­éƒ¨é«˜ä¸­é›»è³‡ç¤¾åœ˜è¯åˆæœƒè­°" />

        <meta name="keywords" content="é›»é›»é», ä¸­é›»æœƒ, SCAICT" />
        <meta property="og:type" content="website" />
        <meta property="og:title" content="ä¸­é›»å•†åº—" />
        <meta property="og:url" content="https://scaict.org" />
        <meta property="og:site_name" content="ä¸­é›»å•†åº—" />
        <meta property="og:description" content="ä½¿ç”¨ä½ çš„é›»é›»é»ä¾†å…Œæ›çå“å§!" />
        <meta property="og:locale" content="zh-TW" />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="https://scaict.org/src/img/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="https://scaict.org/src/img/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="https://scaict.org/src/img/favicon-16x16.png"
        />
        <link
            rel="manifest"
            href="https://scaict.org/src/img/site.webmanifest"
        />
        <link
            rel="mask-icon"
            href="https://scaict.org/src/img/safari-pinned-tab.svg"
            color="#ca4480"
        />
        <meta name="msapplication-TileColor" content="#2b5797" />
        <meta name="theme-color" content="#e9aa11" />
        <link
            rel="stylesheet"
            href="/static/style.css">
        <script
            src="https://kit.fontawesome.com/f9ca08d03f.js"
            crossorigin="anonymous"
        ></script>
    </head>
    <body>
        <nav>
            <a href="/"><i class="fa-solid fa-store"></i> å•†åº—</a>
            <a href="https://discord.com/invite/neQ7QEUcqe"
                ><i class="fa-brands fa-discord"></i>å›åˆ° Discord</a
            >
            {% if ticket %}
            <div class="ticket">{{ ticket }} ğŸŸï¸</div>
            {% endif %} {% if point %}
            <div class="point">{{ point }} âš¡</div>
            {% endif %} {% if avatar %}
            <img src="{{ avatar }}" alt="Avatar" class="avatar" />
            <a href="/logout" class="log"
                ><i class="fa-solid fa-arrow-right-from-bracket"></i
            ></a>
            {% else %}
            <a href="/login"
			   >ç™»å…¥ <i class="fa-solid fa-arrow-right-to-bracket"></i
            ></a>
            {% endif %}
        </nav>
        <main>
            <img
                src="https://scaict.org/src/img/logo.svg"
                alt=""
                class="logo"
            />
            <div class="welcome">å—¨ {{ username }}!</div>
            <h1>æ­¡è¿ä¾†åˆ°ä¸­é›»å•†åº—</h1>
            <p>ä»¥ä¸‹ç‚ºç›®å‰é›»é›»é»å¯å…Œæ›çš„å…§å®¹</p>
            <section>
                <!-- article>((div>img)+(.info>h3+p+button)) -->
                è¼‰å…¥ä¸­...
            </section>
            <div class="footer">Â© 2024 SCAICT All Rights Reserved</div>
        </main>
        <footer>
            <a href="https://www.facebook.com/scaict.tw/" target="_blank"
                ><i class="fa-brands fa-facebook"></i
            ></a>
            <a href="https://www.instagram.com/scaict.tw/" target="_blank"
                ><i class="fa-brands fa-instagram"></i
            ></a>
            <a href="https://github.com/SCAICT" target="_blank"
                ><i class="fa-brands fa-github"></i
            ></a>
        </footer>
        <div class="confirm">
            <div class="content">
                <h2>ç¢ºèªå…Œæ›</h2>
                <p>
                    ä½ ç¢ºå®šè¦èŠ±<span id="buy-cost"></span>è³¼è²·<span
                        id="buy-product"
                    ></span
                    >å—?
                </p>
                <div class="warning">
                    æ­¤ç‚ºå¯¦é«”å‘¨é‚Šï¼Œè«‹æ–¼å¯¦é«”æ´»å‹•æ‹¿åˆ°çå“å¾Œå†é»æ“Šå…Œæ›ï¼Œå¦å‰‡ä¸è£œç™¼çå“ã€‚
                </div>
                <div class="confirm-select">
                    <button onclick="confirm.classList.remove('active')">
                        å–æ¶ˆ
                    </button>
                    <button onclick="buy()">ç¢ºå®š</button>
                </div>
            </div>
        </div>
        <script>
            // load product from /productList to <section>
            let datas = [];
            let selected;
            const section = document.querySelector("section");
            fetch("/productList")
                .then(res => res.json())
                .then(data => {
                    section.innerHTML = "";
                    datas = data.products;
                    datas.forEach(product => {
                        const article = document.createElement("article");
                        var button;
                        if (product.pay == "point")
                            button = `<button
                                    ${
                                        product.stock <= 0
                                            ? "class='outStock'"
                                            : `onclick="select('` +
                                              product.id +
                                              `')"`
                                    }>
                                    ${product.price} âš¡</button>`;
                        else
                            button = `<a class="product-button" href="${product.url}"  target="_blank">${product.price} ğŸŸï¸</a>`;
                        article.innerHTML = `
                            <div class="product-img">
                                <img src="${product.image}" alt="" />
                            </div>
                            <div class="info">
                                <h3>${product.name}</h3>
                                <p>${product.description}</p>
                                <div>
                                    ${button}
                                    <div class="left">åº«å­˜ ${product.stock}</div>
                                </div>
                            </div>
                        `;
                        section.appendChild(article);
                    });
                });

            // buy product
            const confirm = document.querySelector(".confirm");
            const select = id => {
                const product = datas.find(product => product.id === id);
                selected = product;
                document.querySelector("#buy-cost").innerText = product.price;
                document.querySelector("#buy-product").innerText = product.name;
                if (product.stock <= 0) {
                    alert("åº«å­˜ä¸è¶³");
                    return;
                }
                confirm.classList.add("active");
            };

            // confirm buy
            const buy = () => {
                if (!selected) return alert("è«‹é¸æ“‡å•†å“");
                if (selected.pay !== "point")
                    return alert("æ­¤å•†å“ç„¡æ³•ä½¿ç”¨é›»é›»é»è³¼è²·");
                fetch("/buyProduct", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ id: selected.id }),
                })
                    //alert recieved text
                    .then(res => res.text())
                    .then(text => {
                        // if response is html then show it in new page
                        if (text.toLowerCase().startsWith("<!doctype html>")) {
                            document.write(text);
                            return;
                        } else {
                            alert(text);
                            confirm.classList.remove("active");
                            window.location.reload();
                        }
                    })
                    .catch(err => alert(err));
            };
        </script>
    </body>
</html>
